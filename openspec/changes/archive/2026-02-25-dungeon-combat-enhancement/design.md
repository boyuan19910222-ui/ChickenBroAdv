## Context

副本战斗系统（`dungeon-battle-system`）已完成基础框架搭建，包括站位系统、行动点系统、回合顺序、仇恨系统、BOSS 战、队伍编成等。但在实际游戏测试中发现以下问题：

1. **AI 队友固定**：每次进副本都是同一批 AI 职业组合（战士坦克+盗贼+猎人+术士+牧师），缺乏变化
2. **AI 属性不缩放**：AI 队友使用固定属性模板，不随副本等级变化
3. **敌人等级固定**：敌方单位不根据副本推荐等级缩放
4. **波次体验单调**：每波固定数量、固定强度，缺少精英怪和难度递增
5. **仇恨系统失效**：`ThreatSystem` 的 import 路径缺失，导致仇恨逻辑完全未执行
6. **治疗 AI bug**：治疗目标筛选逻辑错误，可能选到已死亡或敌方单位
7. **定位判定失效**：`determineRole` 依赖 `player.primaryTalent` 字段，但该字段从未被设置，导致混合职业永远走默认定位

当前代码基础：
- `PartyFormationSystem.js`（~495 行）：队伍编成
- `DungeonCombatSystem.js`（~3638 行）：副本战斗核心
- `ContextBuilder.js`：战斗上下文构建
- `SkillExecutor.js`：技能执行
- `actions.js`：行动调度

## Goals / Non-Goals

**Goals:**
- 提升副本战斗的多样性和重玩价值（AI 随机化、精英怪）
- 实现合理的数值缩放（AI 等级、敌人等级、波次递增）
- 修复导致系统失效的关键 bug（仇恨 import、治疗筛选、定位判定）
- 保持向后兼容，不破坏已有存档

**Non-Goals:**
- 不涉及新副本/BOSS 内容的添加
- 不涉及 UI 层面的改动
- 不涉及新技能/天赋的设计
- 不涉及 PvP 或野外战斗系统

## Decisions

### D1: AI 队伍随机化方案 — 定位池随机抽取

**选择**：新增 `ROLE_CLASS_POOL` 配置表，每个定位对应一个职业+天赋组合池，创建 AI 时从对应池中随机选取。

**替代方案**：
- 完全随机（任意职业任意定位）→ 可能产生不合理的队伍组合
- 预设多套固定队伍模板轮换 → 扩展性差，新增职业需改所有模板

**理由**：定位池保证队伍结构合理（1坦1治3DPS），同时在每个定位内提供职业多样性。配置驱动，新增职业只需往池中添加条目。

### D2: 等级缩放公式 — 线性 growthPerLevel

**选择**：AI 属性 = 基础值 + growthPerLevel × (等级 - 1)，敌人缩放 = 基础值 × (1 + 0.04 × 等级差)。

**替代方案**：
- 指数缩放 → 高等级数值膨胀严重
- 查表制（每级固定属性表）→ 维护成本高

**理由**：线性缩放易于理解和调试，4%/级的增幅在早期副本（10-25 级）体验适中。

### D3: 天赋定位判定 — 动态计算投入最多的天赋树

**选择**：`determineRole` 新增第三参数 `talents`，当 `primaryTalent` 未设置时，遍历 `player.talents` 各天赋树计算总投入点数，投入最多的树作为主天赋。

**替代方案**：
- 在 `createDefaultPlayer` 里计算并写入 `primaryTalent` → 需要在每次天赋变更时同步更新，增加耦合
- 让玩家手动选择定位 → 增加 UI 复杂度，且可能与实际天赋矛盾

**理由**：按需计算、零额外存储、随天赋变化自动更新，不依赖外部写入。

### D4: 精英怪生成 — 概率触发 + 属性倍率

**选择**：小怪战中 25% 概率将普通怪替换为精英（HP×2.5、伤害×1.8、护甲×1.5），给予双倍经验。

**理由**：简单直接的难度变化机制，概率触发保持不可预测性，倍率可配置。

## Risks / Trade-offs

- **[数值平衡]** 线性缩放公式和精英怪倍率可能在某些等级段偏强/偏弱 → 通过后续游戏测试迭代调整系数
- **[AI 随机性]** 随机队伍可能出现"全近战"或"双术士"等非最优组合 → 当前定位池设计已保证结构（1坦1治3DPS），职业多样性是预期行为
- **[向后兼容]** `determineRole` 新增参数使用默认值，旧调用不受影响 → 已验证只有1处调用
