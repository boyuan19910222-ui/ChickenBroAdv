## Context

当前游戏等级上限为 20 级，expTable 仅 20 条，怪物仅 5 种（1-3 级）。经验值为固定数值无浮动，无等级差惩罚，死亡仅扣 10% 金币。区域 expBonus 数据已定义但未接入。天赋系统代码已按 60 级设计（10 级起每级 1 天赋点，最多 51 点）。CharacterPanel 存在 `player.exp` vs `player.experience` 字段名 Bug。

目标：建立完整的 1-60 级经验升级体系，偶尔操作挂机约 24 小时升至满级。

## Goals / Non-Goals

**Goals:**
- 等级上限扩展至 60 级，采用 4 段式经验曲线
- 经验获取支持浮动和等级差惩罚
- 死亡统一为经验惩罚（30%），不降级保护
- 副本增加小怪/BOSS 击杀经验
- 怪物数据覆盖 1-60 级
- 满级（60 级）后特殊处理
- 旧存档平滑迁移

**Non-Goals:**
- 不实现休息经验（Rested XP）系统
- 不实现区域 expBonus 加成
- 不实现自动换区逻辑
- 不实现组队经验分配（玩家独享全部经验）
- 不新增区域（使用现有 4 个区域）

## Decisions

### D1: 分段经验曲线（4 段式）

**选择**: 分段线性增长，每段独立参数

**替代方案**:
- 纯线性 `a + b·L` — 后期太平，缺乏节奏变化
- 多项式 `a·L²` — 前期太快或后期太慢，单公式无法兼顾

**分段设计**:

```
段1 新手期 (1-20级):   expToNext = 200 + 40·(L-1)        ~3h
段2 稳定期 (20-40级):  expToNext = 1500 + 200·(L-20)     ~9h
段3 深水区 (40-55级):  expToNext = 7000 + 700·(L-40)     ~9h
段4 冲刺期 (55-60级):  expToNext = 18000 + 1200·(L-55)   ~3h
                                                     合计 ~24h
```

expTable 预计算 60 个值存入 GameData.js，运行时直接查表。

### D2: 经验浮动实现

**选择**: 在 CombatSystem 战斗胜利时计算浮动

- 同种怪物每次击杀: `baseExp × (1 + random(-0.1, 0.1))`，±10% 浮动
- 不同种类怪物的 `baseExp` 本身差异达 ±30%（通过怪物数据配置实现，非运行时随机）

**理由**: ±30% 是种类间差异（数据层面），±10% 是同种个体差异（运行时随机）。两者叠加使经验获取不单调。

### D3: 等级差惩罚公式

**选择**: 在经验结算时根据 `playerLevel - monsterLevel` 计算倍率

```
levelDiff = playerLevel - monsterLevel
if levelDiff >= 7: expMultiplier = 0      (不给经验)
if levelDiff >= 5: expMultiplier = 0.5    (-50%)
if levelDiff >= 3: expMultiplier = 0.7    (-30%)
else:              expMultiplier = 1.0    (无惩罚)
```

**注意**: 仅作用于战斗怪物经验，任务经验不受此惩罚。副本小怪/BOSS 经验也受此惩罚（副本有推荐等级范围）。

### D4: 死亡经验惩罚

**选择**: 统一 30% 当前经验进度，最低扣至 0

```
expLost = Math.floor(player.experience * 0.3)
player.experience = Math.max(0, player.experience - expLost)
```

- 野外战斗阵亡: 扣 30% 经验 + 20% 血量复活（保留现有复活逻辑）
- 副本灭团: 扣 30% 经验 + 返回探索界面
- 不降级: 经验最低为 0，不会回退到上一级
- 满级（60 级）: 经验固定为 0，死亡改为扣 10% 金币（沿用旧逻辑）

**替代方案**: 
- 扣固定数值 — 前期太痛后期无感，不如百分比
- 可降级 — 太惩罚，挂机游戏不适合

### D5: 副本经验奖励

**选择**: 副本中每次 encounter 胜利都奖励经验

- 小怪 encounter: 根据怪物数量和等级计算（每只怪按 loot.exp 累加）
- BOSS encounter: BOSS 的 loot.exp 通常是同等级小怪的 3-5 倍
- 通关奖励: 保留，作为额外 bonus
- 副本经验效率约为野外的 1.2-1.5 倍（通过怪物密度和 BOSS 高经验实现）

### D6: 怪物数据扩充策略

**选择**: 在现有 4 个区域框架下扩充怪物，每个区域 5-7 种

```
艾尔文森林  (Lv 1-10):  5 种 (已有 5 种，调整等级分布)
西部荒野    (Lv 10-20): 5 种 (新增)
荆棘谷     (Lv 20-45): 7 种 (新增，跨度大所以多几种)
东瘟疫之地  (Lv 45-60): 7 种 (新增)
```

每种怪物定义: name, level, hp, damage, skills, loot.exp, loot.gold

怪物 baseExp 参考公式: `baseExp ≈ 10 + 3·monsterLevel + 0.05·monsterLevel²`
同区域不同种类间 baseExp 差异约 ±30%（配置时手动调节）。

### D7: 满级处理

**选择**: 60 级后 `addExperience()` 直接 return，不累积经验

- `player.experience` 固定为 0
- `player.experienceToNext` 设为 0（UI 显示"MAX"）
- 打怪仍显示金币奖励但不显示经验
- 死亡改为扣 10% 金币

### D8: 存档迁移 v2→v3

**选择**: 新增 migration version 3

迁移内容:
- `experienceToNext` 重新查表（旧的 20 级 expTable 值 → 新的 60 级 expTable 值）
- 保留当前等级和经验值（不重置玩家进度）
- 如果旧存档等级 > 20（不可能但防御性处理），clamp 到 20

## Risks / Trade-offs

- **[数值平衡]** 分段经验曲线的参数基于估算，实际可能偏快或偏慢 → 上线后通过调整 expTable 常数微调，不影响架构
- **[怪物数量]** 24 种新怪物的数值平衡工作量大 → 使用公式生成基础数值，后续微调
- **[死亡惩罚过重]** 30% 经验在高等级段可能让玩家损失 30-40 分钟进度 → 这是设计意图（后期需小心），但可后续调参
- **[副本经验叠加]** 副本每场 encounter 给经验可能导致刷本效率过高 → 通过副本怪物经验系数控制，保持约 1.2-1.5 倍野外效率
