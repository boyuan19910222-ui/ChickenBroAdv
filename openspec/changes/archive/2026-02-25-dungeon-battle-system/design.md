# 副本战斗系统设计文档

## 概述

本设计文档描述《鸡哥大冒险》副本战斗系统的整体架构，参考暗黑地牢(Darkest Dungeon)的战斗风格，结合魔兽世界的职业体系和BOSS机制。

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│              DungeonCombatSystem（核心控制器）                │
│              src/systems/DungeonCombatSystem.js              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ Positioning │  │ TurnOrder   │  │ ActionPoint         │  │
│  │ System      │  │ System      │  │ System              │  │
│  │             │  │             │  │                     │  │
│  │ - 5v5站位   │  │ - 速度排序  │  │ - 3点制             │  │
│  │ - 空位管理  │  │ - 惊喜机制  │  │ - 技能消耗          │  │
│  │ - 逻辑位置  │  │ - 完全交替  │  │                     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ Threat      │  │ BossPhase   │  │ PartyFormation      │  │
│  │ System      │  │ System      │  │ System              │  │
│  │             │  │             │  │                     │  │
│  │ - 仇恨累计  │  │ - 血量阶段  │  │ - 动态替换          │  │
│  │ - 嘲讽2回合 │  │ - 狂暴15回合│  │ - 职业定位          │  │
│  │             │  │ - 技能预告  │  │                     │  │
│  │             │  │ - 蓄力系统  │  │                     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│                                                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                   PetCombatSystem                        │ │
│  │  - 附属单位（不占位） - 跟随主人目标 - 独立HP           │ │
│  │  - 主人阵亡→宠物联动阵亡 - 宠物可复活                  │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  EventBus 事件驱动通信 (35+ events)                          │
│  UI: DungeonCombatView.vue + TurnOrderBar                   │
│  CharacterPanel: 宠物状态标记（猎人/术士）                    │
└─────────────────────────────────────────────────────────────┘
```

## 战场布局

```
═══════════════════════════════════════════════════════════════════════════
                                战  场
═══════════════════════════════════════════════════════════════════════════

  我方（玩家）5位                                 敌方（怪物/BOSS）5位
  
  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐    ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐
  │ [1] │ │ [2] │ │ [3] │ │ [4] │ │ [5] │    │ [1] │ │ [2] │ │ [3] │ │ [4] │ │ [5] │
  │     │ │     │ │     │ │     │ │     │    │     │ │     │ │     │ │     │ │     │
  │坦克 │ │近战 │ │远程 │ │远程 │ │治疗 │    │前排 │ │     │ │     │ │     │ │后排 │
  │     │ │DPS  │ │DPS  │ │DPS  │ │     │    │     │ │     │ │     │ │     │ │     │
  │ 🛡️  │ │ ⚔️  │ │ 🏹  │ │ 🔮  │ │ ✨  │    │ 👹  │ │ 🐍  │ │ 🦇  │ │ 🦇  │ │ 🦎  │
  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘    └─────┘ └─────┘ └─────┘ └─────┘ └─────┘
  
═══════════════════════════════════════════════════════════════════════════

  BOSS战时，BOSS卡片占据双倍格子宽度（视觉突出）
  BOSS单位标记 isBoss: true，UI通过 .boss-slot 样式渲染
```

## 回合流程（规划-结算两阶段制）

每个回合分为 **规划阶段** 和 **结算阶段** 两个阶段：

```
┌─────────────────────────────────────────────────────────────┐
│                      回合开始                                │
├─────────────────────────────────────────────────────────────┤
│  1. 更新嘲讽持续时间                                        │
│  2. BOSS回合开始处理（狂暴AOE等）                            │
│  3. 重新计算行动顺序（速度排序，仅存活单位）                 │
│  4. 判断惊喜机制（15%概率打乱）                              │
│  5. 重置所有单位行动点                                      │
│  6. 回合开始资源恢复                                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│               📋 规划阶段（等待玩家部署行动）                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❓ 玩家角色是否存活？                                      │
│                                                             │
│  ✅ 存活 → 进入规划阶段                                     │
│     1. UI 显示操作面板（攻击/技能/防御）                     │
│     2. 玩家选择行动和目标 → 行动被预存储                    │
│     3. 玩家点击「开始结算」→ 进入结算阶段                   │
│                                                             │
│  ❌ 阵亡 → 跳过规划，直接进入自动结算                       │
│     （AI队友和敌人全自动行动，无需玩家操控）                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│               ⚡ 结算阶段（按turnOrder顺序执行）             │
├─────────────────────────────────────────────────────────────┤
│  按速度排序的行动顺序，逐个执行：                            │
│                                                             │
│  • 玩家角色：自动执行规划阶段预设的行动                      │
│  • AI队友：根据职业角色AI自动选择行动                        │
│    - 坦克：嘲讽/攻击高仇恨目标                              │
│    - 治疗：优先治疗血量最低队友                              │
│    - DPS：攻击/使用技能                                     │
│  • 敌人/BOSS：按仇恨表选目标执行攻击                        │
│  • 宠物：回合结束时自动攻击（不消耗行动点）                  │
│                                                             │
│  每个单位行动后 → 检查战斗结束条件 → 下一单位                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      回合结束                                │
├─────────────────────────────────────────────────────────────┤
│  1. 处理DOT效果（中毒、流血）                                │
│  2. 减少BUFF/DEBUFF持续时间                                  │
│  3. 回合计数+1                                               │
│  4. 检查战斗结束条件                                         │
│  5. 如未结束 → 回到回合开始，进入下一轮规划阶段              │
└─────────────────────────────────────────────────────────────┘
```

### 核心状态机

```
initializeCombat()
       ↓
  enterPlanningPhase()
       ↓
  ┌──────────────┐    玩家存活     ┌──────────────────┐
  │ planningPhase │ ──────────────→ │ 等待玩家操作      │
  │ = true        │                 │ → setPlannedAction│
  └──────────────┘                 │ → 点击开始结算    │
                                   └──────┬───────────┘
                                          ↓
  ┌──────────────┐    startExecution()   
  │ executing     │ ←───────────────────
  │ Sequence=true │
  └──────┬───────┘
         ↓
  processNextTurn() → handlePlayerTurn/processAIAllyTurn/handleEnemyTurn
         ↓
  roundComplete → startNewRound() → enterPlanningPhase() → 循环

  玩家阵亡时：enterPlanningPhase() 检测到无存活玩家
  → 直接设 executingSequence=true → processNextTurn() → 全自动结算
```

## BOSS战流程（瑟芬迪斯）

```
┌─────────────────────────────────────────────────────────────┐
│  阶段1 (100%-70%)                                           │
│  ═══════════════                                            │
│  • 每回合2次行动                                            │
│  • 技能: 毒液喷射(单体) | 尾巴横扫(前排AOE)                 │
└─────────────────────────────────────────────────────────────┘
                              ↓ 血量≤70%
┌─────────────────────────────────────────────────────────────┐
│  ⚡ 阶段转换                                                │
│  "瑟芬迪斯召唤了触手藤！"                                   │
│  → 位置3生成触手藤                                          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  阶段2 (70%-40%)                                            │
│  ═══════════════                                            │
│  • 每回合2次行动                                            │
│  • 新技能: 缠绕(控制1回合)                                  │
│  • 触手藤协同攻击                                           │
└─────────────────────────────────────────────────────────────┘
                              ↓ 血量≤40%
┌─────────────────────────────────────────────────────────────┐
│  ⚡ 阶段转换                                                │
│  "瑟芬迪斯进入狂暴蜕变！"                                   │
│  → 伤害+30%                                                 │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  阶段3 (40%-0%)                                             │
│  ═══════════════                                            │
│  • 每回合3次行动                                            │
│  • 新技能: 剧毒爆发(全体AOE，需蓄力)                        │
│  • 伤害+30%                                                 │
└─────────────────────────────────────────────────────────────┘
                              ↓ 第15回合
┌─────────────────────────────────────────────────────────────┐
│  💀 狂暴                                                    │
│  "瑟芬迪斯狂暴了！"                                         │
│  → 伤害翻倍                                                 │
│  → 每回合全体毒伤AOE                                        │
└─────────────────────────────────────────────────────────────┘
```

## 仇恨系统

```
┌─────────────────────────────────────────────────────────────┐
│                     仇恨值计算                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  伤害仇恨 = 伤害量 × 1.0                                    │
│  治疗仇恨 = 治疗量 × 0.5                                    │
│  坦克技能 = 效果 × 3.0                                      │
│                                                             │
│  嘲讽 = 强制锁定 2 回合                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘

示例：

  敌人X的仇恨表：
  ┌────────────┬───────────┬────────────┐
  │   玩家     │  仇恨值   │    状态    │
  ├────────────┼───────────┼────────────┤
  │ 🛡️ 战士   │   1500    │  ← 当前目标│
  │ 🏹 猎人   │    800    │            │
  │ ✨ 牧师   │    400    │            │
  └────────────┴───────────┴────────────┘
```

## 行动点系统

```
┌─────────────────────────────────────────────────────────────┐
│                 每回合 3 行动点                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ⭐⭐⭐ 强力技能 (3点)                                       │
│  └─ 治疗祷言、炎爆术、盾墙...                               │
│                                                             │
│  ⭐⭐ 普通技能 (2点)                                         │
│  └─ 致死打击、火球术、治疗术...                             │
│                                                             │
│  ⭐ 快速动作 (1点)                                          │
│  └─ 普通攻击、喝药水、火焰冲击...                           │
│                                                             │
│  ☆ 免费动作 (0点)                                          │
│  └─ 防御姿态（结束回合）                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘

示例回合：
  回合开始: ⚡⚡⚡ (3点)
  → 使用火球术(2点): ⚡ (1点剩余)
  → 使用火焰冲击(1点): 无剩余
  → 回合结束
```

## 数据流

```
┌─────────────────────────────────────────────────────────────┐
│                        CombatSystem                          │
│                            │                                 │
│              ┌─────────────┼─────────────┐                  │
│              ↓             ↓             ↓                  │
│     ┌────────────┐ ┌────────────┐ ┌────────────┐           │
│     │ GameData   │ │ TalentData │ │ DungeonData│           │
│     │            │ │            │ │            │           │
│     │ - 职业速度 │ │ - 天赋定位 │ │ - BOSS配置 │           │
│     │ - 技能消耗 │ │            │ │ - 敌人配置 │           │
│     └────────────┘ └────────────┘ └────────────┘           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 战斗界面UI布局

```
┌─────────────────────────────────────────────────────────────┐
│  副本信息栏（单行合并布局）                                   │
│  ┌──────────────┬──────────────────┬──────────────┐         │
│  │ 洞穴入口守卫 │  🏰 哀嚎洞穴     │  退出副本 🚪 │         │
│  │（遭遇战名称）│  （副本名称）     │  （确认弹窗） │         │
│  └──────────────┴──────────────────┴──────────────┘         │
├─────────────────────────────────────────────────────────────┤
│  行动顺序条 TurnOrderBar                                     │
│  ⚡ 行动顺序 [盗贼][蝙蝠][猎人]...[术士]   回合 N            │
│  （currentRound prop 显示在最右侧）                          │
├─────────────────────────────────────────────────────────────┤
│  战场区域 + 技能面板 + 目标确认弹窗                           │
└─────────────────────────────────────────────────────────────┘

退出副本功能：
  - 点击"退出副本"按钮 → 弹出确认弹窗
  - 确认后：清理 inDungeonCombat 状态 → changeScene('exploration') 返回野外
```

## 文件结构

```
src/
├── systems/
│   ├── DungeonCombatSystem.js  # 核心控制器（规划/结算/事件调度）
│   ├── PositioningSystem.js    # 站位系统（5v5）
│   ├── TurnOrderSystem.js      # 回合顺序系统
│   ├── ActionPointSystem.js    # 行动点系统
│   ├── ThreatSystem.js         # 仇恨系统
│   ├── BossPhaseSystem.js      # BOSS阶段系统（含技能预告/蓄力）
│   ├── PartyFormationSystem.js # 队伍编成系统
│   └── PetCombatSystem.js      # 宠物战斗系统
│
├── data/
│   └── dungeons/
│       └── WailingCaverns.js   # 哀嚎洞穴数据（5怪+BOSS）
│
└── components/
    └── dungeon/
        ├── DungeonCombatView.vue  # 战斗主界面（信息栏/规划/结算UI/技能面板内嵌）
        ├── TurnOrderBar.vue       # 回合顺序预览条（含回合计数）
        └── TargetConfirmDialog.vue # 目标确认弹窗
```

注：技能预告系统（SkillTelegraphSystem）已合并到 BossPhaseSystem 中实现
（startCharging / updateCharging / skillNeedsTelegraph 方法）

## 技术要点

1. **模块化设计**：每个系统独立，通过 EventBus 事件通信
2. **数据驱动**：BOSS、技能、敌人配置集中管理
3. **可扩展性**：新副本只需添加数据配置
4. **性能考虑**：仇恨表使用 Object 结构（`{}`），属性查找 O(1)
5. **两阶段回合制**：规划阶段（玩家部署行动）→ 结算阶段（按速度顺序执行），分离决策与执行
6. **玩家阵亡容错**：玩家角色阵亡后自动跳过规划阶段，AI 全自动结算
7. **BOSS视觉突出**：BOSS 单位 `isBoss: true` 标记，UI 卡片占据双格宽度（`.boss-slot`）
8. **副本退出机制**：战斗中可退出副本返回野外探索，需确认弹窗防误触。退出逻辑在 DungeonCombatView.vue 中实现（直接操作系统属性+场景切换），而非系统层方法
9. **近战距离检查**：PositioningSystem 定义了 `meleeMaxDistance=400` 和 `isMeleeInRange()`，近战单体技能限制只能攻击前 2 个存活敌人（按 slot 升序），远程/法术单体不受限制
10. **AI 行为树驱动**：所有 AI 单位（队友、敌人、BOSS、野外怪物、宠物）通过 AIDecisionSystem + 行为树决策，小怪使用 `dungeonEnemy` 行为树选择技能
11. **主人阵亡→宠物联动阵亡**：三处队员阵亡路径（`applyDamageToParty`、`_syncUnitHp`、`_handleUnitDeath`）统一调用 `PetCombatSystem.onOwnerDeath()`，宠物 HP 归零并标记死亡
12. **宠物状态面板**：CharacterPanel 为猎人/术士职业显示宠物状态标记（emoji + HP 条 + 名称），宠物阵亡时灰暗显示"已阵亡"

## 核心事件流

```
系统 → UI 方向：
  dungeon:combatStart        → 初始化战斗界面
  dungeon:planningPhaseStart → 进入规划阶段，显示操作面板
  dungeon:actionPlanned      → 行动已部署，更新UI标签
  dungeon:executionStart     → 进入结算阶段，隐藏操作面板
  dungeon:playerTurnStart    → 玩家回合开始（结算中带 isExecuting 标志）
  dungeon:aiTurnStart        → AI回合开始
  dungeon:enemyTurnStart     → 敌人回合开始
  dungeon:unitTargeting      → 单位锁定目标（高亮）
  dungeon:combatUpdate       → 战斗状态更新
  dungeon:damageDealt/Received/healingDone → 伤害/治疗浮动数字

UI → 系统 方向：
  dungeon:playerAction       → 玩家选择行动（规划阶段存储/结算阶段执行）
  dungeon:startExecution     → 玩家点击"开始结算"
  dungeon:selectTarget       → 选择目标
  dungeon:selectSkill        → 选择技能

额外事件（实现中存在，原设计未列出）：
  dungeon:encounterTransition   → 遭遇战过渡界面
  dungeon:highlightUnit         → 高亮当前行动单位（UI通过CSS class实现）
  dungeon:actionPointsUpdated   → 行动点更新
  dungeon:targetSelected        → 目标已选中
  dungeon:skillSelected         → 技能已选中
  dungeon:defeat                → 战败
  dungeon:complete              → 副本通关
  dungeon:log                   → 战斗日志消息
  dungeon:exit                  → 退出副本（Vue组件emit）
  dungeon:start                 → 启动副本
  exp:gain                      → 经验值获取

场景切换：
  scene:change → 'exploration'  （副本结束/退出时切回野外）
```
