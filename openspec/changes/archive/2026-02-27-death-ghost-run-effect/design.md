## Context

当前死亡流程在`CombatSystem.endCombat(false)`中直接执行：玩家HP≤0时立即应用死亡惩罚，设置HP为20%，清理战斗状态，2秒后切换到探索场景。整个过程无UI反馈，体验过于直接。

现有技术栈：Vue 3组件 + EventBus事件系统 + StateManager状态管理。UI组件通过事件监听游戏状态变化。

约束：
- 必须保持现有死亡惩罚逻辑不变
- 不能破坏现有的存档/加载机制  
- 需集成到现有的Vue组件和事件系统

## Goals / Non-Goals

**Goals:**
- 在现有死亡流程中插入跑尸阶段，无缝集成
- 创建全屏覆盖UI组件，支持黑白滤镜和交互阻塞
- 实现"跑尸中..."动态点数动画（1-5个点循环）
- 随机5-10秒后自动结束，继续原死亡逻辑
- 通过事件系统解耦，便于测试和维护

**Non-Goals:**
- 不改变死亡惩罚计算或复活机制
- 不添加跳过功能（保持魔兽世界体验）
- 不支持自定义跑尸时间（避免配置复杂度）

## Decisions

### 1. 组件架构：独立覆盖层组件

**决策**: 创建`DeathGhostOverlay.vue`独立组件，挂载到App根组件
**原因**: 
- 全屏覆盖需要最高z-index，避免被其他组件遮挡
- 独立组件便于状态管理和测试
- 可复用于未来其他全屏效果

**替代方案**: 修改现有布局组件 → 拒绝，耦合度太高

### 2. 事件驱动的状态管理

**决策**: 使用EventBus事件 `ghost-run:start` + `ghost-run:end`
**原因**:
- 与现有架构一致（如`combat:victory`、`combat:defeat`）
- CombatSystem无需直接依赖UI组件
- 便于其他系统监听跑尸状态（如音效）

**事件流设计**:
```
CombatSystem → ghost-run:start → DeathGhostOverlay显示
                      ↓
            跑尸计时器(5-10秒随机)
                      ↓
DeathGhostOverlay → ghost-run:end → CombatSystem继续死亡逻辑
```

### 3. 交互阻塞策略

**决策**: CSS `pointer-events: none` + 全屏遮罩阻塞点击
**原因**:
- 简单可靠，无需修改每个UI组件
- CSS层面阻塞，性能开销最小
- 视觉上明确传达"无法操作"状态

**替代方案**: JavaScript事件拦截 → 复杂度高，容易遗漏

### 4. 动画实现：CSS + JavaScript计时器

**决策**: CSS动画处理视觉效果，JavaScript控制点数变化逻辑
**原因**:
- CSS动画性能更好，支持硬件加速
- JavaScript控制业务逻辑（1→5→1循环），职责清晰
- 易于调试和维护

**点数动画逻辑**:
- 每500ms变化一次点数
- 1→2→3→4→5→4→3→2→1循环
- 使用`setInterval`而非`requestAnimationFrame`，保证时间准确性

### 5. 随机时间生成：组件初始化时确定

**决策**: 组件显示时立即生成5-10秒随机时间，避免运行时计算
**原因**:
- 确保时间的真实随机性，避免玩家预测
- 简化生命周期管理，减少状态复杂度

## Risks / Trade-offs

### 用户体验风险
**风险**: 5-10秒强制等待可能让急躁玩家感到沮丧
**缓解**: 动画效果和魔兽情怀增加可接受度，未来可考虑添加配置选项

### 性能风险  
**风险**: 全屏滤镜效果可能在低端设备上造成卡顿
**缓解**: 使用CSS filter优化，避免JavaScript实时处理；可添加低配置模式

### 状态管理复杂度
**风险**: 跑尸期间玩家状态的一致性（如HP显示、buff状态）
**缓解**: 跑尸期间不修改player状态，仅在结束后应用死亡逻辑

### 边缘情况
**风险**: 跑尸期间用户刷新浏览器或断网
**缓解**: 
- 跑尸状态不存储到StateManager，刷新后直接跳过跑尸
- 添加最长超时保护（15秒强制结束）

## Migration Plan

**部署步骤**:
1. 添加`DeathGhostOverlay.vue`组件到项目
2. 修改`CombatSystem.endCombat(false)`，添加事件触发
3. 在App.vue中注册覆盖层组件
4. 测试各种死亡场景（boss战、普通怪、宠物战）

**回滚策略**:
- 组件化设计支持快速移除
- 通过feature flag控制启用/禁用
- 数据库和存档格式无变化，回滚风险极低

## Open Questions

- 是否需要音效配合跑尸效果？
- 多人模式下其他玩家是否能看到跑尸状态？（当前为单机游戏，暂不考虑）
- 未来是否需要不同死亡方式的不同跑尸时间？