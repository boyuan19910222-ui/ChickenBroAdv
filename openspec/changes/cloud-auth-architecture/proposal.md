# 云端登录架构改造

## 背景

当前游戏架构是单机优先、联机可选的模式：
- 单机模式无需登录，存档保存在 localStorage
- 联机模式（集合石）需要单独登录，角色数据不上传服务器

这种架构导致：
1. 玩家无法跨设备继续游戏
2. 单机和联机数据分离，体验割裂
3. 存档丢失风险高（本地存储）

## 目标

将游戏改造为**纯联网游戏**：

1. **登录必选**：进入游戏必须先登录
2. **云端存档**：所有角色数据保存在云端，支持跨设备
3. **统一体验**：单机和联机内容共享同一套角色数据
4. **简化入口**：集合石改为游戏内模态框

## 范围

### 包含

- 登录界面改造（自动登录、反馈二维码）
- 新增角色选择界面
- 云端存档系统（API + 数据库）
- 集合石改为模态框形式
- 联机战斗UI复用单机布局
- 条件显示的聊天Tab

### 不包含

- 大厅聊天功能（删除）
- 导入/导出存档功能（删除）
- 离线游玩支持

## 核心决策

| 决策项 | 选择 |
|--------|------|
| 离线支持 | 不支持，必须联网 |
| 角色上限 | 最多5个角色 |
| 联机战斗控制 | 完全自动战斗，玩家观战 |
| 集合石入口 | 游戏主界面按钮，打开模态框 |
| 角色删除 | 永久删除，不保留恢复 |
| 自动登录Token | 30天有效期 |
| 存档同步 | 关键节点 + 定时（60秒） |
| 多设备登录 | 单设备，新登录踢掉旧登录 |
| 副本聊天位置 | 仅底部Tab，不显示右侧聊天面板 |

## 成功标准

1. 玩家可以在任何设备登录并继续游戏
2. 登录流程顺畅（自动登录体验良好）
3. 角色创建、选择、删除功能正常
4. 集合石匹配和战斗流程正常
5. 存档数据可靠同步

## 风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 服务器故障导致无法游戏 | 高 | 服务监控、快速恢复机制 |
| 数据库故障导致存档丢失 | 高 | 定期备份 |
| 网络波动影响体验 | 中 | 存档本地缓存 + 重试机制 |

## 时间线

- 阶段1：后端API和数据库改造
- 阶段2：前端路由和登录改造
- 阶段3：角色选择界面
- 阶段4：集合石模态框
- 阶段5：战斗界面统一
- 阶段6：测试和优化
